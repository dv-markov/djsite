# Работа из консоли

# перейти в папку проекта Python
cd D:/Python/django/djsite

# создание виртуального окружения
python -m venv venv

# активоровать виртуальное окружение
.\venv\Scripts\activate

# деактивировать вирутальное окружение
deactivate

# установить django
pip install django

# список команд ядра django
django-admin

# создание сайта (проекта django):
django-admin startproject <имя_сайта>
django-admin startproject coolsite

# перейти в корневой каталог проекта
cd <имя_сайта>
cd coolsite

# запуск сервера, нужно находиться в корневом каталоге проекта
python manage.py runserver
python manage.py runserver 4000
python manage.py runserver 192.168.1.1:4000

# создание приложения, запускать из главной директории сайта
python manage.py startapp <app_name>

# создание миграции
python manage.py makemigrations

# просмотр sql-запроса, который будет выполнен при создании таблицы
python manage.py sqlmigrate women 0001

# выполнение миграции, создание таблицы в базе данных
pyhton manage.py migrate

# вход в консоль фреймворка Django
python manage.py shell

# импорт класса для работы в ORM
from women.models import Women

# ссылка на объект - результат предыдущего действия
w1 = _

# сохранение объекта в БД
w1.save()

# атрибут pk - идентификатор записи; primary key
w1.pk

# подключение функции connection
from django.db import connection

# просмотр предыдущего запроса к БД
connection.queries

# Методы менеджера записей objects
<class>.objects.create
Women.objects.create(title='Ума Турман', content = 'Биография Умы Турман')

# выход из оболочки Django shell
exit()

# чтение записей
Women.objects.all()
Women.objects.filter(title='Энн Хэтуэй')
Women.objects.filter(pk__gte=2)  # pk >= 2
Women.objects.exclude(pk=2)
Women.objects.get(pk=2)  # возвращает только одну запись
# случае, если количество найденных записей > 1, или запись не найдена, метод get генерирует исключение
# а метод filter возвращает список или пустой список

# выбор записи с сортировкой
Women.objects.filter(pk__lte=4).order_by('title')
Women.objects.order_by('-time_update')  # обратный порядок сортировки

# изменение существующих записей
wu = Women.objects.get(pk=2)
wu.title = 'Марго Робби'
wu.content = 'Биография Марго Робби'

# удаление записей
wd = Women.objects.filter(pk__gte=4)
wd.delete()

# Lesson #7
# Сбор статических файлов перед деплоем
python manage.py collecstatic

# Lesson 9
# создание категорий и обновление полей категория в моделях women
from women.models import *
Category.objects.create(name='Актрисы')
Category.objects.create(name='Певицы')
w_list = Women.objects.all()
w_list.update(cat_id=1)

# Lesson 10
# Administraion panel
python manage.py createsuperuser
root
root@valveadvisor.ru
1234

# Lesson 16 - Работа с БД, ORM
from women.models import *

# срез - * SELECT * *
Women.objects.all()[3:8]

# сортировка - * ORDER BY *
Women.objects.order_by('pk')
# обратная сортировка
Women.objects.order_by('-pk')
Women.objects.all().reverse()

# первичный ключ меньше или равен 2 - * WHERE *
Women.objects.filter(pk__lte=2)

# обработка данных связанных таблиц
w = Women.objects.get(pk=1)
w.cat  # ссылка на объект категории

# Первичные модели
# У любой первичной модели создается специальное свойство для каждой вторичной модели: <вторичная_модель>_set
# С помощью этого объекта можно выбирать все связанные записи
c = Category.objects.get(pk=1)
c.women_set
c.women_set.all()

# Фильтры полей - lookups - * WHERE, LIKE, iLIKE *
__gt, __gte - больше
--lt, __gte - меньше
__contains - содержит
__icontains - содержит без учета регистра (не работает для не-ASCII символов в SQLite)

__in - значение в списке, Women.objects.filter(pk__in=[2,5,11,12])
Women.objects.filter(pk__in=[2,5,11], is_published=True) - объединение, И
Women.objects.filter(cat__in=[1,2]) - __in по вшешнему ключу
Women.objects.filter(cat_id__in=[1,2])
cats = Category.objects.all()
Women.objects.filter(cat__in=cats)

# Класс Q - * AND, OR, NOT *
# & - лоигическое И (приоритет 2)
# | - логическое ИЛИ (приоритет 3)
# ~ - логическое НЕ (приоритет 1)
from django.db.models import Q
Women.objects.filter(Q(pk__lt=5) | Q(cat_id=2))
Women.objects.filter(~Q(pk__lt=5) &  Q(cat_id=2))

# Быстрое получение записей из таблицы - * FIRST, LAST *
Women.objects.first()
Women.objects.order_by('pk').last()

# Записи по дате - * DATE, TIME *
Women.objects.latest('time_update')
Women.objects.earliest('time_update')

# Предыдущуя или следующая запись
w = Women.objects.get(pk=7)
w.get_previous_by_time_update()
w.get_next_by_time_update()
w.get_next_by_time_update(pk__gt=10)

# проверка существования и получение числа записей, работают быстро
c3 = Category.objects.get(pk=3)
c3.women_set.exists()
c3.women_set.count()
Women.objects.filter(pk__gt=4).count()

# обращение к первичной модели через атрибут * INNER JOIN *
Women.objects.filter(cat__slug='aktrisy')
Women.objects.filter(cat__in=[1])  # эквивалент
Women.objects.filter(cat__name='Певицы')  # эквивалент
Women.objects.filter(cat__name__contains='цы')
# Обратное соответствие
Category.objects.filter(women__title__contains='ли')
# Убрать дубликаты
Category.objects.filter(women__title__contains='ли').distinct()

# Aggregation functions
from django.db.models import *
Women.objects.aggregate(Min('cat_id'))
Women.objects.aggregate(Min('cat_id'), Max('cat_id'))
Women.objects.aggregate(cat_min=Min('cat_id'), cat_max=Max('cat_id'))
Women.objects.filter(pk__gt=4).aggregate(res=Avg('cat_id'))

# Выбор записи и конкретных ее полей - этот метод работает быстрее
Women.objects.values('title', 'cat_id').get(pk=1)
Women.objects.values('title', 'cat__name').get(pk=1)
